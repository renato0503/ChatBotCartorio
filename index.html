<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cart√≥rio ‚Ä¢ Chat com IA</title>
<style>
  :root{
    --panel:#111b21;
    --accent:#25d366;
    --me:#005c4b;
    --them:#202c33;
    --text:#e9edef;
    --sub:#8696a0;
    --btn:#233138;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,#111b21 0%,#0b141a 100%);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;
    color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center;
  }
  .phone{width:min(420px,100vw);height:min(780px,100vh);background:var(--panel);border:1px solid #1f2c33;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.03) inset;display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #1f2c33;background:#1f2c33}
  .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#1d9161,#0f4c3a);display:grid;place-items:center;font-weight:700;color:#d7f6e6}
  .title{display:flex;flex-direction:column;line-height:1.1}
  .title b{font-size:14.5px}
  .title span{font-size:12px;color:var(--sub)}
  .verified{display:inline-block;transform:translateY(1px);margin-left:6px;width:16px;height:16px;border-radius:50%;background:var(--accent);color:#093023;font-size:12px;font-weight:900;display:grid;place-items:center}
  .chat{flex:1;overflow-y:auto;padding:14px;background:url('data:image/svg+xml;utf8,\
    <svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22160%22 viewBox=%220 0 160 160%22>\
    <g fill=%22%23202c33%22 fill-opacity=%220.35%22>\
    <circle cx=%2220%22 cy=%2220%22 r=%221%22 />\
    <circle cx=%2290%22 cy=%2280%22 r=%221%22 />\
    <circle cx=%22140%22 cy=%2240%22 r=%221%22 />\
    <circle cx=%2270%22 cy=%22130%22 r=%221%22 />\
    </g></svg>') repeat;background-attachment:fixed}
  .bubble{max-width:85%;padding:10px 12px;border-radius:10px;margin:8px 0;position:relative;box-shadow:0 1px 0 rgba(0,0,0,.1);word-wrap:break-word;white-space:pre-wrap}
  .me{background:var(--me);margin-left:auto;border-top-right-radius:2px}
  .them{background:var(--them);margin-right:auto;border-top-left-radius:2px}
  .time{display:block;text-align:right;color:#b8c6cc;font-size:11px;opacity:.8;margin-top:6px}
  .buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .buttons button{background:var(--btn);color:var(--text);border:1px solid #2c3c43;border-radius:18px;padding:8px 12px;cursor:pointer;font-size:13px}
  .composer{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid #1f2c33;background:#111b21}
  .composer input[type=text]{flex:1;background:#202c33;border:1px solid #2f3b41;color:var(--text);border-radius:20px;padding:12px 14px;font-size:14px;outline:none}
  .composer button{background:var(--accent);color:#06351f;border:0;border-radius:20px;padding:10px 16px;font-weight:700;cursor:pointer}
  .composer label{background:#202c33;border:1px solid #2f3b41;padding:10px;border-radius:20px;cursor:pointer;font-size:13px}
  .link-like{color:#bfe3d2;text-decoration:underline;cursor:pointer}
  .foot{text-align:center;font-size:11px;color:var(--sub);padding:6px 10px;border-top:1px dashed #23313a}
  .toggle{margin-left:auto;font-size:12px;display:flex;gap:8px;align-items:center}
  .toggle input{transform:scale(1.1)}
  /* New styles for schedule grid */
  .schedule-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
  }
  .schedule-slot {
    background-color: var(--btn);
    color: var(--text);
    border: 1px solid #2c3c43;
    border-radius: 8px;
    padding: 8px 10px;
    cursor: pointer;
    font-size: 12px;
    text-align: center;
    transition: background-color 0.2s ease;
  }
  .schedule-slot.occupied {
    background-color: #3a4a53;
    color: var(--sub);
    cursor: not-allowed;
    opacity: 0.7;
  }
  .schedule-slot.available {
      border-color: var(--accent);
  }
  .schedule-slot:not(.occupied):hover {
      background-color: #2a3a43;
  }
</style>
</head>
<body>
  <div class="phone" role="application" aria-label="Chat do Cart√≥rio">
    <div class="topbar">
      <div class="avatar" aria-hidden="true">C</div>
      <div class="title">
        <b>Cart√≥rio Oficial</b>
        <span>N√∫mero verificado <span class="verified" title="Verificado">‚úì</span></span>
      </div>
      <div class="toggle" title="Responder usando IA offline">
        <label for="ai">IA</label>
        <input id="ai" type="checkbox" checked>
      </div>
    </div>
    <div id="chat" class="chat" aria-live="polite"></div>
    <div class="composer">
      <input id="text" type="text" placeholder="Digite aqui" autocomplete="off" aria-label="Mensagem">
      <label>üìé<input id="file" type="file" style="display:none" multiple></label>
      <button id="send">Enviar</button>
    </div>
    <div class="foot">Funciona offline no navegador. Pre√ßos e prazos fict√≠cios.</div>
  </div>

<script>
(function(){
  const chat = document.getElementById('chat');
  const input = document.getElementById('text');
  const sendBtn = document.getElementById('send');
  const fileInp = document.getElementById('file');
  const aiToggle = document.getElementById('ai');

  // --- Estado e Configura√ß√µes ---
  const state = {
      awaitingSector: false,
      awaitingDescription: false,
      awaitingStatusId: false,
      awaitingOrderCPF: false, // For video call scheduling input phase
      chosenSector: null,
      currentOrderCode: null,
      currentCPF: null,
      videoCallSchedule: {}, // Stores current day's slot availability: { '09:00-09:30': 'available' | 'occupied' }
      videoCallBookedSlots: {} // Stores booking details: { '09:00-09:30': { orderCode: 'ATD-XXXXXX', cpf: 'XXXXXXXXXXX' } }
  };

  const CPF_REGEX = /^\d{11}$/;
  const ORDER_CODE_REGEX = /^ATD-\d{6}$/;
  const VIDEO_CALL_PDF_URL = 'https://corregedoria-mc.tjmt.jus.br/corregedoria-arquivos-prod/cms/Provimento_n_49_2024_CGJ_Rep_83bd1305fc.pdf';

  // --- HELPERS ---
  function slugify(text) {
    return text.toString().toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '_')
      .replace(/[^\w-]+/g, '')
      .replace(/_{2,}/g, '_')
      .replace(/^-+/, '')
      .replace(/-+$/, '');
  }

  function parsePrice(value) {
    if (!value) return 'N√£o especificado';
    const cleaned = value.trim();
    const low = cleaned.toLowerCase();
    if (low === 'gratuito') return 'Gratuito';
    if (cleaned === '-' || low.includes('valor a ser calculado') || low === 'r$ -') return 'Valor a ser calculado';
    return cleaned.replace(/\s+/g,' ');
  }

  function parseBoolean(value) {
    if (!value) return false;
    return value.trim().toLowerCase() === 'sim';
  }

  function parseDocuments(value) {
    if (!value || value.trim() === '') return ['Nenhum documento especificado'];
    const cleaned = value.trim();
    if (cleaned.toLowerCase() === 'anexo') return ['Anexo, detalhes ser√£o solicitados'];
    const parts = cleaned.split(/[,;\n]+/).map(doc => doc.trim()).filter(doc => doc);
    return parts.length > 0 ? parts : ['Nenhum documento especificado'];
  }

  function cleanText(value) {
    if (!value) return 'N√£o especificado';
    return value.trim().replace(/\s+/g,' ');
  }

  function formatList(items) {
      if (!items || items.length === 0) return '- Nenhum especificado';
      return items.map(item => `‚Ä¢ ${item}`).join('\n');
  }

  // --- Data: CSV & Specific Services ---
  const csvData = `Tabelionato de Notas	Procura√ß√£o P√∫blica	 R$ 120,00 	Sim	WhatsApp	1 dia √∫til 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	1 dia √∫til
Tabelionato de Notas	Escritura P√∫blica	 Valor a ser calculado 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Traslados	 R$ 51,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Carta de Senten√ßa	 Valor a ser calculado 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Guia de ITBI	 R$ 45,90 	Sim	WhatsApp	1 dia √∫til 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	1 dia √∫til
Tabelionato de Notas	Testamento	 Valor a ser calculado 	Sim	WhatsApp	Prazo indefinido	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Prazo indefinido
Tabelionato de Notas	Ata Notarial	 Valor a ser calculado 	Sim	WhatsApp	Prazo indefinido	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Prazo indefinido
Tabelionato de Notas	Apostilamento de Haia	 R$ 120,00 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	E - Notariado	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Nascimento	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Casamento	 R$ 501,90 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	√ìbito	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Busca de Registro	 R$ 31,45 	Sim	WhatsApp	At√© 30 dias 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	At√© 30 dias
Registro Civil	2¬™ Via de Certid√£o (Breve Relato)	 R$ 25,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	2¬™ Via de Certid√£o (Inteiro Teor)	 R$ 19,05 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	Livro E 	 R$ 115,95 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	Averba√ß√µes / Retifica√ß√µes	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Reconhecimento de Firma	Abertura de Firma	 R$ 11,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Reconhecimento por Semelhan√ßa	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Reconhecimento por Autenticidade	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autentica√ß√£o	 R$ 4,25 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Materializa√ß√£o 	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autentica√ß√£o Digital	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Desmaterializa√ß√£o 	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Sinal P√∫blico 	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Comunicado de Venda	 R$ 92,09 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autoriza√ß√£o de Viagem Eletr√¥nica	 R$ 199,90 	Sim	WhatsApp	Imediato	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Protesto	Certid√£o Negativa / Positiva	 R$ 51,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Consulta CPF / CNPJ	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Realizar Apontamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Certid√£o de Intima√ß√£o 	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Boleto em Apontamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Cancelamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Carta de Anu√™ncia 	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis`;

  const serviceLines = csvData.trim().split('\n');
  const headers = ['setor','servico','valor_bruto','responsavel_interno','canal_abertura','tempo_medio_resposta','horario_atendimento','pode_ser_online_100','documentos_necessarios','encaminhar_orgao','sistema_usado','forma_pagamento','prazo_entrega'];

  // Process CSV data
  const csvServices = serviceLines.map(line => {
      const values = line.split('\t');
      const serviceData = {};
      headers.forEach((header, index) => { serviceData[header] = values[index] ? values[index].trim() : ''; });

      const setor = cleanText(serviceData.setor);
      const servico = cleanText(serviceData.servico);
      const id = slugify(servico);

      return {
          id,
          setor,
          nome: servico,
          valor_formatado: parsePrice(serviceData.valor_bruto),
          responsavel_interno: parseBoolean(serviceData.responsavel_interno),
          canal_abertura: cleanText(serviceData.canal_abertura),
          tempo_medio_resposta: cleanText(serviceData.tempo_medio_resposta),
          horario_atendimento: cleanText(serviceData.horario_atendimento),
          pode_ser_online_100: parseBoolean(serviceData.pode_ser_online_100),
          documentos: parseDocuments(serviceData.documentos_necessarios),
          encaminhar_orgao: parseBoolean(serviceData.encaminhar_orgao),
          sistema_usado: cleanText(serviceData.sistema_usado),
          forma_pagamento: cleanText(serviceData.forma_pagamento),
          prazo_entrega: cleanText(serviceData.prazo_entrega)
      };
  });

  // Define specific services not directly from CSV
  const specificServices = [
      // Reconhecimento de Firma Items
      { id: 'rec_firma_abertura', nome: 'Abertura de Firma', setor: 'Reconhecimento de Firma', docs_text: 'RG ou CNH original e CPF.' },
      { id: 'rec_firma_semelhanca', nome: 'Reconhecimento por Semelhan√ßa', setor: 'Reconhecimento de Firma', docs_text: 'Documento j√° com firma aberta no cart√≥rio.' },
      { id: 'rec_firma_autenticidade', nome: 'Reconhecimento por Autenticidade', setor: 'Reconhecimento de Firma', docs_text: 'Documento original mais presen√ßa do titular com documento oficial (RG ou CNH).' },
      { id: 'rec_firma_autenticacao_copia', nome: 'Autentica√ß√£o de C√≥pias', setor: 'Reconhecimento de Firma', docs_text: 'Documento original mais c√≥pia simples.' },
      { id: 'rec_firma_materializacao', nome: 'Materializa√ß√£o', setor: 'Reconhecimento de Firma', docs_text: 'Documento digital em PDF.' },
      { id: 'rec_firma_autenticacao_digital', nome: 'Autentica√ß√£o Digital', setor: 'Reconhecimento de Firma', docs_text: 'Documento digital em PDF.' },
      { id: 'rec_firma_desmaterializacao', nome: 'Desmaterializa√ß√£o', setor: 'Reconhecimento de Firma', docs_text: 'Documento f√≠sico original.' },
      { id: 'rec_firma_sinal_publico', nome: 'Sinal P√∫blico', setor: 'Reconhecimento de Firma', docs_text: 'Documento com assinatura de tabeli√£o ou registrador.' },
      { id: 'rec_firma_comunicado_venda', nome: 'Comunicado de Venda', setor: 'Reconhecimento de Firma', docs_text: 'CRV (recibo do ve√≠culo) ou equivalente mais documento do vendedor.' },
      { id: 'rec_firma_autorizacao_viagem', nome: 'Autoriza√ß√£o de Viagem Eletr√¥nica', setor: 'Reconhecimento de Firma', docs_text: 'Documentos pessoais dos pais ou respons√°veis mais dados do menor mais certid√£o de nascimento.' },

      // Registro Civil Items
      { id: 'reg_civil_nascimento', nome: 'Nascimento', setor: 'Registro Civil', docs_text: 'DNV mais documentos dos pais (RG, CPF).' },
      { id: 'reg_civil_casamento', nome: 'Casamento', setor: 'Registro Civil', docs_text: 'RG, CPF, certid√£o de nascimento atualizada dos noivos, comprovante de resid√™ncia, mais duas testemunhas com documento pessoal.' },
      { id: 'reg_civil_obito', nome: '√ìbito', setor: 'Registro Civil', docs_text: 'Declara√ß√£o de √ìbito (DO), documentos do falecido e do declarante.' },
      { id: 'reg_civil_busca', nome: 'Busca de Registro', setor: 'Registro Civil', docs_text: 'Nome completo, data aproximada do registro e filia√ß√£o.' },
      { id: 'reg_civil_2via_breve', nome: '2¬™ Via de Certid√£o (Breve Relato)', setor: 'Registro Civil', docs_text: 'Dados completos do registro e documento pessoal do solicitante.' },
      { id: 'reg_civil_2via_inteiro', nome: '2¬™ Via de Certid√£o (Inteiro Teor)', setor: 'Registro Civil', docs_text: 'Dados completos do registro.' },
      { id: 'reg_civil_livro_e', nome: 'Livro E', setor: 'Registro Civil', docs_text: 'Documento judicial ou religioso conforme o caso.' },
      { id: 'reg_civil_averbacoes', nome: 'Averba√ß√µes / Retifica√ß√µes', setor: 'Registro Civil', docs_text: 'Documento judicial ou administrativo que determina a altera√ß√£o.' },

      // Tabelionato de Notas Items
      { id: 'tab_notas_procuracao', nome: 'Procura√ß√£o P√∫blica', setor: 'Tabelionato de Notas', docs_text: 'RG, CPF e dados do outorgante e outorgado.' },
      { id: 'tab_notas_escritura', nome: 'Escritura P√∫blica', setor: 'Tabelionato de Notas', docs_text: 'Documentos pessoais e documentos do im√≥vel quando aplic√°vel.' },
      { id: 'tab_notas_traslados', nome: 'Traslados', setor: 'Tabelionato de Notas', docs_text: 'Informar qual escritura deseja traslado.' },
      { id: 'tab_notas_carta_sentenca', nome: 'Carta de Senten√ßa', setor: 'Tabelionato de Notas', docs_text: 'Processo com decis√£o transitada em julgado.' },
      { id: 'tab_notas_itbi', nome: 'Guia de ITBI', setor: 'Tabelionato de Notas', docs_text: 'Informa√ß√µes do im√≥vel e guia emitida pela prefeitura.' },
      { id: 'tab_notas_testamento', nome: 'Testamento', setor: 'Tabelionato de Notas', docs_text: 'Documento de identidade do testador.' },
      { id: 'tab_notas_ata_notarial', nome: 'Ata Notarial', setor: 'Tabelionato de Notas', docs_text: 'Documento, fato ou situa√ß√£o a ser atestada.' },
      { id: 'tab_notas_apostilamento_haia', nome: 'Apostilamento de Haia', setor: 'Tabelionato de Notas', docs_text: 'Documento original a apostilar.' },
      { id: 'tab_notas_e_notariado', nome: 'E-Notariado', setor: 'Tabelionato de Notas', docs_text: 'Documento original.' },
  ];

  // Combine CSV services with specific ones for a unified list
  const allServices = [...csvServices, ...specificServices.map(s => ({
      ...s,
      // Default values for fields not present in specificServices but needed for consistency
      valor_formatado: 'Verificar no cart√≥rio',
      responsavel_interno: false,
      canal_abertura: 'Presencial ou Virtual',
      tempo_medio_resposta: 'Vari√°vel',
      horario_atendimento: '09:00 as 17:00',
      pode_ser_online_100: true,
      documentos: s.docs_text ? s.docs_text.split('.') : ['N√£o especificado'],
      encaminhar_orgao: false,
      sistema_usado: 'Sistema Interno',
      forma_pagamento: 'PIX ou D√©bito',
      prazo_entrega: 'Vari√°vel'
  }))];

  const setores = ['Tabelionato de Notas','Registro Civil','Reconhecimento de Firma','Protesto','Financeiro','Atendimento Geral','Ouvidoria'];

  // Bank Information as requested
  const bankInfo = {
    razSocial: 'Oficial do Registro Civil das Pessoas Naturais com fun√ß√µes notariais.',
    nomeFantasia: 'Cart√≥rio Coxip√≥ do Ouro',
    cnpj: '41.567.424/0001-10',
    banco: 'Banco do Brasil',
    agencia: '3940-3',
    conta: '53874-4',
    tipo: 'Conta Corrente',
    pix: '41.567.424/0001-10',
    aviso: 'Use somente estes dados. O cart√≥rio n√£o envia mensagens por n√∫meros diferentes nem solicita pagamento por links aleat√≥rios.'
  };

  // --- IA Logic ---
  const IA = (function(){
    const intents = {
      // Existing intents...
      dados_bancarios:{'pix':2,'dados':1.5,'banc':1.5,'conta':1.3,'ag√™ncia':1.2,'agencia':1.2,'transfer':1.2,'pagamento':1.0},
      status:{'status':2,'protocolo':2,'andamento':1.5,'acompanhar':1.5,'atd':1.8},
      atendente:{'humano':2,'pessoa':1.5,'atendente':2,'falar':1.2,'setor':1.0},
      tabela_precos:{'pre√ßo':2,'precos':2,'valor':2,'tabela':2,'quanto':1.3,'custa':1.3},
      tabela_emolumentos:{'emolumentos':3, 'provimento': 2}, // Added for PDF link detection

      // Mapped payloads for new specific services
      procuracao_publica:{'procura√ß√£o':2,'procuracao':2},
      escritura_publica:{'escritura':2},
      traslados:{'traslado':2,'traslados':2},
      carta_de_sentenca:{'carta':2,'senten√ßa':2,'sentenca':2},
      guia_de_itbi:{'itbi':3,'guia':2},
      testamento:{'testamento':3},
      ata_notarial:{'ata':3,'notarial':3},
      apostilamento_de_haia:{'apostilamento':3,'haia':3},
      e_notariado:{'e-notariado':3,'digital':2},

      nascimento:{'nascimento':3},
      casamento:{'casamento':3},
      obito:{'obito':3,'√≥bito':3},
      busca_de_registro:{'busca':3,'registro':1.5},
      '2a_via_de_certidao_breve_relato':{'breve':2,'relato':2},
      '2a_via_de_certidao_inteiro_teor':{'inteiro':2,'teor':2},
      livro_e:{'livro':2,'e':1},
      averbacoes_retificacoes:{'averba√ß√£o':3,'retifica√ß√£o':3,'averbacao':3,'retificacao':3},

      abertura_de_firma:{'abertura':2,'firma':3},
      reconhecimento_por_semelhan√ßa:{'semelhan√ßa':3,'semelhanca':3},
      reconhecimento_por_autenticidade:{'autenticidade':3},
      autenticacao:{'autentica√ß√£o':3,'autenticacao':3,'c√≥pia':2,'copia':2},
      materializacao:{'materializa√ß√£o':3,'materializacao':3},
      autenticacao_digital:{'autentica√ß√£o':3,'autenticacao':3,'digital':2},
      desmaterializacao:{'desmaterializa√ß√£o':3,'desmaterializacao':3},
      sinal_publico:{'sinal':2,'p√∫blico':2,'publico':2},
      comunicado_de_venda:{'comunicado':2,'venda':3},
      autorizacao_de_viagem_eletronica:{'autoriza√ß√£o':3,'autorizacao':3,'viagem':2,'eletr√¥nica':1.5},

      certidao_negativa_positiva:{'certid√£o':2,'negativa':1.5,'positiva':1.5},
      consulta_cpf_cnpj:{'consulta':2,'cpf':1.5,'cnpj':1.5},
      realizar_apontamento:{'apontamento':3,'realizar':2},
      certidao_de_intimacao:{'certid√£o':2,'intima√ß√£o':2,'intimacao':2},
      boleto_em_apontamento:{'boleto':2,'apontamento':2},
      cancelamento:{'cancelamento':3},
      carta_de_anuencia:{'anu√™ncia':3,'anuencia':3}
    };

    function tokenize(text){
      return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/[^a-z0-9]+/).filter(Boolean);
    }

    function score(text){
      const toks = tokenize(text);
      const scores = {};
      for(const intent in intents){
        let s = 0;
        const w = intents[intent];
        for(const tk of toks){
          for(const key in w){
            const k = key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
            if(tk.startsWith(k)) s += w[key];
          }
        }
        // Specific keyword boosts
        if (intent === 'dados_bancarios' && text.toLowerCase().includes('dados banc')) s += 0.5;
        if (intent === 'tabela_emolumentos' && text.toLowerCase().includes('emolumentos')) s += 1.0;
        if (intent === 'tabela_precos' && text.toLowerCase().includes('tabela')) s += 0.5;

        scores[intent]=s;
      }
      let best = {intent:'',score:0};
      for(const k in scores){ if(scores[k]>best.score){ best={intent:k,score:scores[k]}; } }
      return best;
    }
    return {score};
  })();

  // Mapping detected IA intents to specific payloads
  const iaIntentToPayloadMap = {
    dados_bancarios:'dados_bancarios',
    status:'status_query', // Use dedicated query payload
    atendente:'atendente',
    tabela_precos:'tabela_precos',
    tabela_emolumentos:'tabela_emolumentos_pdf', // Payload for official PDF

    // Mappings for specific services
    procuracao_publica:'tab_notas_procuracao',
    escritura_publica:'tab_notas_escritura',
    traslados:'tab_notas_traslados',
    carta_de_sentenca:'tab_notas_carta_sentenca',
    guia_de_itbi:'tab_notas_itbi',
    testamento:'tab_notas_testamento',
    ata_notarial:'tab_notas_ata_notarial',
    apostilamento_de_haia:'tab_notas_apostilamento_haia',
    e_notariado:'tab_notas_e_notariado',

    nascimento:'reg_civil_nascimento',
    casamento:'reg_civil_casamento',
    obito:'reg_civil_obito',
    busca_de_registro:'reg_civil_busca',
    '2a_via_de_certidao_breve_relato':'reg_civil_2via_breve',
    '2a_via_de_certidao_inteiro_teor':'reg_civil_2via_inteiro',
    livro_e:'reg_civil_livro_e',
    averbacoes_retificacoes:'reg_civil_averbacoes',

    abertura_de_firma:'rec_firma_abertura',
    reconhecimento_por_semelhan√ßa:'rec_firma_semelhanca',
    reconhecimento_por_autenticidade:'rec_firma_autenticidade',
    autenticacao:'rec_firma_autenticacao_copia', // Mapped to specific item
    materializacao:'rec_firma_materializacao',
    autenticacao_digital:'rec_firma_autenticacao_digital',
    desmaterializacao:'rec_firma_desmaterializacao',
    sinal_publico:'rec_firma_sinal_publico',
    comunicado_de_venda:'rec_firma_comunicado_venda',
    autorizacao_de_viagem_eletronica:'rec_firma_autorizacao_viagem',
  };

  // Map service IDs to their data objects for easy lookup
  const serviceDetailMap = {};
  allServices.forEach(s => {
      serviceDetailMap[s.id] = s;
  });

  // --- CORE LOGIC ---
  function findServiceById(id) {
    return allServices.find(s => s.id === id);
  }

  // Function to format service details, handling both CSV and specific items
  function formatServiceDetails(service) {
      if (!service) return 'Servi√ßo n√£o encontrado';
      let details = `*${service.nome}*\n`;
      details += `Setor: ${service.setor}\n`;
      details += `Valor: ${service.valor_formatado}\n`;
      details += `Prazo de entrega: ${service.prazo_entrega}\n`;
      details += `Tempo m√©dio de resposta inicial: ${service.tempo_medio_resposta}\n`;
      details += `Hor√°rio de atendimento: ${service.horario_atendimento}\n`;
      details += `Pode ser feito 100% online? ${service.pode_ser_online_100 ? 'Sim' : 'N√£o'}\n`;
      details += `Forma de pagamento: ${service.forma_pagamento}\n`;

      details += `\n*Documentos Necess√°rios*\n`;
      if (service.docs_text) { // Use specific text for new items
          details += service.docs_text.split('.').map(d => d.trim()).filter(d => d).map(d => `‚Ä¢ ${d}.`).join('\n');
      } else if (service.documentos && service.documentos.length > 0 && service.documentos[0] !== 'Nenhum documento especificado') { // Fallback for CSV items
          service.documentos.forEach(doc => { details += `‚Ä¢ ${doc}\n`; });
      } else {
          details += '‚Ä¢ Nenhum documento especificado';
      }
      return details;
  }

  // Function to generate a checklist file content
  function checklistBlob(service){
      const text=[
          `--- Checklist ${service.nome} ---`,
          `Setor: ${service.setor}`,
          `Valor Estimado: ${service.valor_formatado}`,
          `Prazo Estimado: ${service.prazo_entrega}`,
          `Hor√°rio de Atendimento: ${service.horario_atendimento}`,
          `Pode ser feito 100% online? ${service.pode_ser_online_100 ? 'Sim' : 'N√£o'}`,
          `Forma de Pagamento: ${service.forma_pagamento}`,
          '',
          'Documentos Necess√°rios',
          ...(service.docs_text ? service.docs_text.split('.').map(d => d.trim()).filter(d => d) : (service.documentos && service.documentos.length > 0 ? service.documentos : ['Nenhum especificado'])).map((d,i)=>`${i+1}. ${d.endsWith('.') ? d : d + '.'}`), // Ensure items end with a period if they don't already
          '',
          'Observa√ß√µes',
          'Checklist demonstrativo'
      ].join('\n');
      return URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  }

  // Display service details and add options
  function showService(serviceId){
    const service = findServiceById(serviceId);
    if(!service) { addBubble('Servi√ßo n√£o encontrado.','them'); return; }

    const formattedDetails = formatServiceDetails(service);
    const bubble = addBubble(formattedDetails,'them');

    // Add download button if documents are specified
    if (service.documentos && service.documentos.length > 0 && service.documentos[0] !== 'Nenhum documento especificado' || service.docs_text) {
        const link = el('span','link-like','Baixar checklist');
        link.addEventListener('click',()=>{
            const url=checklistBlob(service);
            const a=document.createElement('a');
            a.href=url;
            a.download=`Checklist - ${slugify(service.nome)}.txt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
        bubble.appendChild(el('div','time',' '));
        bubble.appendChild(link);
    }

    // Add relevant navigation buttons
    addButtons([
      {label:'Falar com atendente',payload:'atendente',meta:{setor:service.setor,assunto:service.nome}},
      {label:'Ver outros servi√ßos', payload:'inicio'}
    ]);
  }

  // Display the price table (from CSV) and optionally the official PDF link
  function showTabela(showPdfLink = false){
      const rows = allServices.map(s =>
          `<tr>
             <td>${s.nome}</td>
             <td>${s.setor}</td>
             <td>${s.valor_formatado}</td>
             <td>${s.prazo_entrega}</td>
             <td>${s.pode_ser_online_100 ? 'Sim' : 'N√£o'}</td>
           </tr>`
      ).join('');
      addBubble('Tabela demonstrativa de servi√ßos','them');
      addBubble(`
          <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead>
                  <tr>
                      <th style="border:1px solid #2a3a41;padding:6px">Servi√ßo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Setor</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Pre√ßo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Prazo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Online?</th>
                  </tr>
              </thead>
              <tbody>${rows}</tbody>
          </table>`,'them',true);

      const buttons = [{label:'Voltar ao Menu Principal', payload:'inicio'}];
      if (showPdfLink) {
          // Add button to open the official PDF
          buttons.unshift({label:'Abrir Tabela Oficial (PDF)', payload:'tabela_emolumentos_pdf'});
      }
      addButtons(buttons);
  }

  // Display bank information (new format)
  function showBankInfo(){
      let bankText = `*Dados Oficiais para Pagamento*\n\n`
                   + `Raz√£o Social: ${bankInfo.razSocial}\n`
                   + `Nome Fantasia: ${bankInfo.nomeFantasia}\n`
                   + `CNPJ: ${bankInfo.cnpj}\n`
                   + `Banco: ${bankInfo.banco}\n`
                   + `Ag√™ncia: ${bankInfo.agencia}\n`
                   + `Conta Corrente: ${bankInfo.conta}\n`
                   + `\n*Chave PIX*\n`
                   + `${bankInfo.pix}\n\n`
                   + `*Aviso*\n`
                   + `${bankInfo.aviso}`;
      addBubble(bankText,'them');
      addButtons([{label:'Copiar PIX',payload:'copiar_pix'},{label:'Voltar ao Menu Principal',payload:'inicio'}]);
  }

  // Copy text to clipboard
  function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(()=>addBubble('Chave PIX copiada. Cole no seu aplicativo banc√°rio','them')).catch(()=>addBubble('Falha ao copiar. Copie manualmente','them'));
  }

  // --- Handoff & Status Handling ---
  function startHandoff(pref){
      // Reset state related to handoff/ticket creation
      state.awaitingSector = true;
      state.awaitingDescription = false;
      state.chosenSector = null;
      state.currentOrderCode = null; // Reset for potential reuse
      state.currentCPF = null;       // Reset for potential reuse
      state.awaitingOrderCPF = false; // Reset video call state

      let intro = `Para atendimento humano, por favor, escolha o setor desejado ou descreva sua demanda.`;
      if(pref && pref.assunto) {
          intro = `Encaminho para o setor de ${pref.setor} com assunto "${pref.assunto}". Por favor, confirme o setor ou escolha outro:`;
      }
      addBubble(intro,'them');
      // Display sector options as buttons
      addButtons(setores.map(s => ({label:s, payload:'setor_'+s})).concat([{label:'Cancelar',payload:'inicio'}]));
  }

  function confirmSector(sector){
      state.awaitingSector = false;
      state.awaitingDescription = true;
      state.chosenSector = sector;
      addBubble(`Setor "${sector}" selecionado. Por favor, descreva sua demanda em uma frase.`,'them');
  }

  // Create a new support ticket
  function openTicket(desc){
      const id = 'ATD-' + Math.random().toString(36).substring(2, 8).toUpperCase(); // Generate unique ATD-XXXXXX code
      const sectorForStore = state.chosenSector;
      addBubble(`Atendimento iniciado com sucesso.\nProtocolo: ${id}\nSetor: ${sectorForStore}\nResumo: ${desc}\nUm atendente ir√° responder em breve.`,'them');

      // Reset state after ticket creation
      state.awaitingDescription = false;
      state.chosenSector = null;

      // Store ticket info locally
      localStorage.setItem(id, JSON.stringify({id, status:'Em an√°lise', sector:sectorForStore, description:desc, requestedAt: new Date().toISOString()}));

      // Provide options to check status or return to menu
      addButtons([
          {label:'Verificar Status', payload:'status_query', meta:{id:id}},
          {label:'Menu Principal', payload:'inicio'}
      ]);
  }

  // Initiate status check flow
  function checkStatusFlow(){
      state.awaitingStatusId = true;
      state.awaitingOrderCPF = false; // Ensure other states are reset
      addBubble('Por favor, informe o protocolo (ex: ATD-123456) para verificar o status.','them');
  }

  // Resolve and display status for a given protocol ID
  function resolveStatus(id){
      const raw = localStorage.getItem(id);
      if(!raw){
          addBubble(`Protocolo "${id}" n√£o localizado. Verifique o n√∫mero e tente novamente.`,'them');
          state.awaitingStatusId = false; // Reset state
          return;
      }
      const data = JSON.parse(raw);

      // Simulate status based on time elapsed
      const requestedTime = new Date(data.requestedAt);
      const now = new Date();
      const diffMinutes = (now - requestedTime) / (1000 * 60);

      let status = 'Em an√°lise';
      if (diffMinutes < 15) status = 'Em an√°lise';
      else if (diffMinutes < 60) status = 'Aguardando triagem';
      else if (diffMinutes < 180) status = 'Em andamento';
      else status = 'Aguardando resposta final';

      addBubble(`*Status do Protocolo ${id}*\nSetor: ${data.sector}\nStatus: ${status}\nDescri√ß√£o: ${data.description}`,'them');
      state.awaitingStatusId = false; // Reset state
      addButtons([{label:'Menu Principal', payload:'inicio'}]);
  }

  // Handle user input for Order of Service status query
  function handleOrderStatusQuery(text) {
      const match = text.trim().toUpperCase();
      if (ORDER_CODE_REGEX.test(match)) {
          resolveStatus(match);
      } else {
          addBubble('Formato de protocolo inv√°lido. Por favor, use o formato ATD-123456.','them');
      }
  }

  // Handle user input for Cart√£o de Firma status query
  function handleFirmCardStatusQuery(text) {
      const cpf = text.trim().replace(/[^\d]/g, ''); // Extract only digits
      if (CPF_REGEX.test(cpf)) {
          const responses = [
              'üü¢ Firma V√°lida pronta para uso.',
              'üü° Firma Vencida. Procure o cart√≥rio para renova√ß√£o.',
              'üî¥ Sem Cart√£o de Assinatura. Procure o cart√≥rio para emitir.'
          ];
          const randomIndex = Math.floor(Math.random() * responses.length); // Simulate different outcomes
          addBubble(responses[randomIndex],'them');
      } else {
          addBubble('Formato de CPF inv√°lido. Por favor, insira um CPF com 11 d√≠gitos num√©ricos.','them');
      }
      // Always return to main menu after this query
      addButtons([{label:'Menu Principal', payload:'inicio'}]);
  }

  // --- Video Call Scheduling Logic ---
  const scheduleSlots = [
      "09:00‚Äì09:30", "09:30‚Äì10:00", "10:00‚Äì10:30", "10:30‚Äì11:00",
      "11:00‚Äì11:30", "11:30‚Äì12:00", "13:00‚Äì13:30", "13:30‚Äì14:00",
      "14:00‚Äì14:30", "14:30‚Äì15:00"
  ];

  // Initialize schedule state (check localStorage for today's bookings)
  function initVideoCallState() {
      state.awaitingOrderCPF = true; // User needs to provide Order Code and CPF
      state.currentOrderCode = null;
      state.currentCPF = null;

      const todayKey = `videoCallBooked_${new Date().toISOString().split('T')[0]}`; // Unique key for today
      const storedBookings = localStorage.getItem(todayKey);
      if (storedBookings) {
          state.videoCallBookedSlots = JSON.parse(storedBookings);
      } else {
          state.videoCallBookedSlots = {}; // Reset if no bookings for today
      }

      // Update current schedule availability based on stored bookings
      scheduleSlots.forEach(slot => {
          state.videoCallSchedule[slot] = state.videoCallBookedSlots[slot] ? 'occupied' : 'available';
      });
  }

  // Display the scheduling grid
  function displayVideoCallSchedule() {
      const scheduleDiv = el('div', 'schedule-grid');
      scheduleSlots.forEach(slot => {
          const slotDiv = el('div', `schedule-slot ${state.videoCallSchedule[slot]}`);
          slotDiv.textContent = slot;
          if (state.videoCallSchedule[slot] === 'available') {
              slotDiv.addEventListener('click', () => {
                  confirmVideoCallBooking(slot); // Handle selection
              });
          }
          scheduleDiv.appendChild(slotDiv);
      });

      // Add the schedule grid to the chat
      const scheduleBubble = el('div', 'bubble them');
      scheduleBubble.innerHTML = `<h4>Selecione um hor√°rio dispon√≠vel:</h4>`;
      scheduleBubble.appendChild(scheduleDiv);
      chat.appendChild(scheduleBubble);
      chat.scrollTop = chat.scrollHeight;
  }

  // Confirm booking when a slot is selected
  function confirmVideoCallBooking(slot) {
      const orderCode = state.currentOrderCode;
      const cpf = state.currentCPF;

      if (!orderCode || !cpf) {
          addBubble('Erro: Protocolo e CPF n√£o definidos para agendamento.','them');
          return; // Should not happen if logic is correct
      }

      // Mark slot as occupied and store booking details
      state.videoCallSchedule[slot] = 'occupied';
      state.videoCallBookedSlots[slot] = { orderCode, cpf };

      // Save updated bookings to localStorage
      const todayKey = `videoCallBooked_${new Date().toISOString().split('T')[0]}`;
      localStorage.setItem(todayKey, JSON.stringify(state.videoCallBookedSlots));

      // Display confirmation message
      const confirmationText = `‚úÖ Agendamento confirmado!\n`
                           + `Protocolo: ${orderCode}\n`
                           + `CPF: ${cpf}\n`
                           + `Hor√°rio: ${slot}\n`
                           + `Uma videoconfer√™ncia ser√° realizada neste hor√°rio.`;
      addBubble(confirmationText, 'them');

      // Reset state after successful booking
      state.awaitingOrderCPF = false;
      state.currentOrderCode = null;
      state.currentCPF = null;

      // Return to main menu
      addButtons([{label:'Menu Principal', payload:'inicio'}]);
  }

  // Handle the user's request to start the video call scheduling process
  function handleVideoCallRequest(text){
      // Extract Order Service code and CPF from the input text
      const orderCodeMatch = text.match(/ordem de servi√ßo (\S+)/i);
      const cpfMatch = text.match(/cpf (\d{11})/i);

      if (orderCodeMatch) state.currentOrderCode = orderCodeMatch[1].toUpperCase();
      if (cpfMatch) state.currentCPF = cpfMatch[1];

      // Check if both required pieces of information are valid
      if (state.currentOrderCode && CPF_REGEX.test(state.currentCPF)) {
           initVideoCallState(); // Initialize schedule (load bookings, set availability)
           displayVideoCallSchedule(); // Show the grid
      } else {
           // Prompt user for correct format if input is incomplete or invalid
           addBubble('Por favor, forne√ßa ambos: a Ordem de Servi√ßo e o CPF v√°lido (11 d√≠gitos). Use o formato: "Informar Ordem de Servi√ßo [c√≥digo] e CPF [11 d√≠gitos]".','them');
      }
  }

  // --- Payload Handling ---
  function handlePayload(payload, meta){
    // Reset states that might interfere with unrelated flows before proceeding
    state.awaitingSector = false;
    state.awaitingDescription = false;
    state.awaitingStatusId = false;
    state.awaitingOrderCPF = false;
    state.chosenSector = null;
    state.currentOrderCode = null;
    state.currentCPF = null;

    // Handle menu navigation payloads
    if (payload.startsWith('menu_')) {
        switch (payload) {
            case 'menu_certidoes': showCertidoesMenu(); break;
            case 'menu_reconhecimento': showReconhecimentoMenu(); break;
            case 'menu_autenticacao': showAutenticacaoMenu(); break; // Redirects to Reconhecimento Menu
            case 'menu_procuracoes_escrituras': showProcuracoesEscriturasMenu(); break;
            case 'menu_protesto': showProtestoMenu(); break;
            case 'menu_registro_civil': showRegistroCivilMenu(); break; // New specific menu
            case 'menu_tabelionato_notas': showTabelionatoNotasMenu(); break; // New specific menu
            default: addBubble(`Menu desconhecido ${payload}`, 'them');
        }
        return;
    }

    // Handle specific actions and commands
    switch (payload) {
        case 'inicio':
            addBubble('Como posso ajudar hoje?','them');
            showInitialMenu(); // Display the main welcome menu
            return;
        case 'copiar_pix':
            copyToClipboard(bankInfo.pix);
            return;
        case 'atendente':
            startHandoff(meta); // Start the handoff process
            return;
        case 'status_query': // Handle status check request
            if (meta && meta.id) { resolveStatus(meta.id); return; } // If ID provided
            checkStatusFlow(); // Otherwise, ask for ID
            return;
        case 'dados_bancarios':
            showBankInfo(); // Display new bank info
            return;
        case 'tabela_precos':
            showTabela(); // Show the demonstrative table
            return;
        case 'tabela_emolumentos_pdf':
            addBubble('Abrindo Tabela Oficial de Emolumentos em nova aba...','them');
            window.open(VIDEO_CALL_PDF_URL, '_blank'); // Open PDF in new tab
            addButtons([{label:'Continuar no chat', payload:'inicio'}]); // Allow user to return
            return;
        case 'agendar_video': // Payload to initiate video call scheduling
            state.awaitingOrderCPF = true; // Set state to expect Order Code & CPF
            addBubble('Para agendar uma videoconfer√™ncia, por favor, informe a Ordem de Servi√ßo e o CPF no formato: "Informar Ordem de Servi√ßo [c√≥digo] e CPF [11 d√≠gitos]".','them');
            return;
    }

    // Handle selection of sectors during handoff
    if (payload.startsWith('setor_')) {
        confirmSector(payload.replace('setor_', ''));
        return;
    }

    // Handle requests for specific service details
    const service = findServiceById(payload);
    if (service) {
        showService(service.id); // Display details for the found service
        return;
    }

    // Fallback for any unrecognized payload
    addBubble(`N√£o entendi o comando ou servi√ßo "${payload}". Tente novamente.`,'them');
    addButtons([{label:'Menu Principal', payload:'inicio'}]);
  }

  // Route user input text to the appropriate handler or IA
  function parseFreeText(text){
    const t = text.toLowerCase();

    // Prioritize specific commands and queries
    if (t.includes('informar ordem de servi√ßo') || t.includes('status protocolo')) {
        handleOrderStatusQuery(text);
        return;
    }
    if (t.includes('informar cpf') && !t.includes('e') && !t.includes('ordem de servi√ßo')) { // Avoid conflict with video call request
        handleFirmCardStatusQuery(text);
        return;
    }
     if (t.includes('informar ordem de servi√ßo') && t.includes('e') && t.includes('cpf')) {
        handleVideoCallRequest(text); // Handle video call scheduling request
        return;
    }

    // Handle sequential state-based interactions
    if(state.awaitingSector && setores.some(s => t === s.toLowerCase())){
        const sector = setores.find(s => s.toLowerCase() === t);
        confirmSector(sector); // Confirm selected sector
        return;
    }
    if(state.awaitingDescription && t){
        openTicket(text); // Create ticket with description
        return;
    }
    if(state.awaitingStatusId){
        handleOrderStatusQuery(text); // Reuse status query handler if expecting ID
        return;
    }
     if(state.awaitingOrderCPF){ // Handle input phase for video call scheduling
        const orderCodeMatch = text.match(/ordem de servi√ßo (\S+)/i);
        const cpfMatch = text.match(/cpf (\d{11})/i);

        if (orderCodeMatch) state.currentOrderCode = orderCodeMatch[1].toUpperCase();
        if (cpfMatch) state.currentCPF = cpfMatch[1];

        // Check if both Order Code and CPF are valid before proceeding
        if (state.currentOrderCode && CPF_REGEX.test(state.currentCPF)) {
             initVideoCallState(); // Initialize schedule state
             displayVideoCallSchedule(); // Show available slots
        } else {
             addBubble('Por favor, forne√ßa ambos: a Ordem de Servi√ßo e o CPF v√°lido (11 d√≠gitos).','them');
        }
        return;
    }

    // Handle keywords mapping to menu navigation
    if (t.includes('certid√µes') || t.includes('registro') || t.includes('nascimento') || t.includes('casamento') || t.includes('√≥bito')) { handlePayload('menu_certidoes'); return; }
    if (t.includes('reconhecimento') || t.includes('firma') || t.includes('autentica√ß√£o') || t.includes('c√≥pia') || t.includes('xerox') || t.includes('materializa√ß√£o') || t.includes('desmaterializa√ß√£o') || t.includes('sinal p√∫blico') || t.includes('comunicado de venda') || t.includes('autoriza√ß√£o de viagem')) { handlePayload('menu_reconhecimento'); return; }
    if (t.includes('procura√ß√£o') || t.includes('escritura') || t.includes('im√≥vel') || t.includes('venda') || t.includes('compra') || t.includes('traslado') || t.includes('itbi') || t.includes('testamento') || t.includes('ata notarial') || t.includes('haia') || t.includes('e-notariado')) { handlePayload('menu_procuracoes_escrituras'); return; }
    if (t.includes('protesto') || t.includes('apontamento') || t.includes('anu√™ncia') || t.includes('boleto')) { handlePayload('menu_protesto'); return; }

    // Try to match direct service lookup by keywords
    const directServiceMatch = allServices.find(s =>
        s.id.toLowerCase() === t ||
        s.nome.toLowerCase().includes(t) ||
        s.nome.toLowerCase().split(' ').some(word => t.includes(word))
    );
    if (directServiceMatch) { handlePayload(directServiceMatch.id); return; }

    // Use IA if enabled and confidence is sufficient
    if(aiToggle.checked){
      const iaPayload = IA.score(text); // Get IA intent and score
      // Use threshold 1.5 for IA confidence
      if(iaPayload.score >= 1.5 && iaIntentToPayloadMap[iaPayload.intent]){
          const payload = iaIntentToPayloadMap[iaPayload.intent];
          // Handle IA results: route to menus, specific actions, or service details
          if (payload.startsWith('menu_') || ['tabela_precos', 'dados_bancarios', 'tabela_emolumentos_pdf'].includes(payload)) {
              handlePayload(payload); // Navigate menus or perform actions
          } else {
              // Attempt to display details for a specific service identified by IA
              const serviceFromIA = findServiceById(payload);
              if (serviceFromIA) {
                  showService(serviceFromIA.id);
              } else {
                  addBubble('A IA identificou um servi√ßo, mas n√£o consegui encontrar detalhes. Tente o menu.','them');
              }
          }
          return;
      }
    }

    // Handle specific keywords mapping to direct actions not covered by menus or IA
    if(t.includes('atendente') || t.includes('humano') || t.includes('falar com')) { handlePayload('atendente'); return; }
    if(t.includes('dados banc') || t.includes('pix') || t.includes('conta')) { handlePayload('dados_bancarios'); return; }
    if(t.includes('tabela') || t.includes('pre√ßo') || t.includes('valor') || t.includes('emolumentos') || t.includes('quanto custa')) {
        // Distinguish between general price table and official emoluments PDF
        if (t.includes('emolumentos') || t.includes('provimento')) {
            handlePayload('tabela_emolumentos_pdf'); // Official PDF
        } else {
            handlePayload('tabela_precos'); // Demonstrative table
        }
        return;
    }
    if (t.includes('agendar videoconfer√™ncia') || t.includes('marcar reuni√£o')) {
        handlePayload('agendar_video'); // Initiate video call scheduling
        return;
    }

    // Default fallback message if input is not understood
    addBubble('N√£o entendi. Por favor, use os bot√µes do menu, digite o nome do servi√ßo, ou um dos comandos como "Informar CPF [seu CPF]", "Informar Ordem de Servi√ßo [c√≥digo]", "Agendar Videoconfer√™ncia", ou "Atendente".','them');
  }

  // --- UI Functions ---

  // Displays the initial welcome message and numbered menu
  function showInitialMenu(){
      addBubble('üìë‚ú® Ol√°, seja bem-vindo(a) ao atendimento virtual do Cart√≥rio de Paz e Notas de Coxip√≥ do Ouro! Estou aqui para te ajudar de forma r√°pida e pr√°tica. Para agilizar seu atendimento, selecione uma das op√ß√µes abaixo digitando o n√∫mero correspondente ou clicando no bot√£o:', 'them');
      const buttons = [
          {label:'1. Reconhecimento de Firma', payload:'menu_reconhecimento'},
          {label:'2. Registro Civil', payload:'menu_registro_civil'},
          {label:'3. Tabelionato de Notas', payload:'menu_tabelionato_notas'},
          {label:'4. Tabela de Emolumentos', payload:'tabela_emolumentos_pdf'},
          {label:'5. Dados Banc√°rios', payload:'dados_bancarios'},
          {label:'6. Falar com um atendente', payload:'atendente'}
      ];
      addButtons(buttons);
  }

  // Menu for Certid√µes and Registros
   function showCertidoesMenu(){
      addButtons([
          {label:'Nascimento', payload:'reg_civil_nascimento'},
          {label:'Casamento', payload:'reg_civil_casamento'},
          {label:'√ìbito', payload:'reg_civil_obito'},
          {label:'Busca de Registro', payload:'reg_civil_busca'},
          {label:'2¬™ Via Breve Relato', payload:'reg_civil_2via_breve'},
          {label:'2¬™ Via Inteiro Teor', payload:'reg_civil_2via_inteiro'},
          {label:'Livro E', payload:'reg_civil_livro_e'},
          {label:'Averba√ß√µes e Retifica√ß√µes', payload:'reg_civil_averbacoes'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  // Menu for Reconhecimento de Firma
  function showReconhecimentoMenu(){
      addButtons([
          {label:'1.1 Abertura de Firma', payload:'rec_firma_abertura'},
          {label:'1.2 Reconhecimento por Semelhan√ßa', payload:'rec_firma_semelhanca'},
          {label:'1.3 Reconhecimento por Autenticidade', payload:'rec_firma_autenticidade'},
          {label:'1.4 Autentica√ß√£o de C√≥pias', payload:'rec_firma_autenticacao_copia'},
          {label:'1.5 Materializa√ß√£o', payload:'rec_firma_materializacao'},
          {label:'1.6 Autentica√ß√£o Digital', payload:'rec_firma_autenticacao_digital'},
          {label:'1.7 Desmaterializa√ß√£o', payload:'rec_firma_desmaterializacao'},
          {label:'1.8 Sinal P√∫blico', payload:'rec_firma_sinal_publico'},
          {label:'1.9 Comunicado de Venda', payload:'rec_firma_comunicado_venda'},
          {label:'1.10 Autoriza√ß√£o de Viagem Eletr√¥nica', payload:'rec_firma_autorizacao_viagem'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  // Menu for Autentica√ß√£o (links to Reconhecimento Menu as per prompt)
  function showAutenticacaoMenu() {
      addBubble('Para autentica√ß√£o de c√≥pias e outros servi√ßos relacionados a firma, por favor, escolha uma das op√ß√µes abaixo:', 'them');
      showReconhecimentoMenu(); // Reuse the Reconhecimento menu
  }

   // Menu for Registro Civil
   function showRegistroCivilMenu() {
        addButtons([
            {label:'2.1 Nascimento', payload:'reg_civil_nascimento'},
            {label:'2.2 Casamento', payload:'reg_civil_casamento'},
            {label:'2.3 √ìbito', payload:'reg_civil_obito'},
            {label:'2.4 Busca de Registro', payload:'reg_civil_busca'},
            {label:'2.5 2¬™ Via Breve Relato', payload:'reg_civil_2via_breve'},
            {label:'2.6 2¬™ Via Inteiro Teor', payload:'reg_civil_2via_inteiro'},
            {label:'2.7 Livro E', payload:'reg_civil_livro_e'},
            {label:'2.8 Averba√ß√µes e Retifica√ß√µes', payload:'reg_civil_averbacoes'},
            {label:'Voltar', payload:'inicio'}
        ]);
    }

    // Menu for Tabelionato de Notas
    function showTabelionatoNotasMenu() {
        addButtons([
            {label:'3.1 Procura√ß√£o P√∫blica', payload:'tab_notas_procuracao'},
            {label:'3.2 Escritura P√∫blica', payload:'tab_notas_escritura'},
            {label:'3.3 Traslados', payload:'tab_notas_traslados'},
            {label:'3.4 Carta de Senten√ßa', payload:'tab_notas_carta_sentenca'},
            {label:'3.5 Guia de ITBI', payload:'tab_notas_itbi'},
            {label:'3.6 Testamento', payload:'tab_notas_testamento'},
            {label:'3.7 Ata Notarial', payload:'tab_notas_ata_notarial'},
            {label:'3.8 Apostilamento de Haia', payload:'tab_notas_apostilamento_haia'},
            {label:'3.9 E-Notariado', payload:'tab_notas_e_notariado'},
            {label:'Voltar', payload:'inicio'}
        ]);
    }

  // Menu for Protesto
  function showProtestoMenu(){
      addButtons([
          // Adjusted payload IDs for clarity and consistency
          {label:'Certid√£o Negativa ou Positiva', payload:'protesto_certidao_negativa_positiva'},
          {label:'Consulta CPF ou CNPJ', payload:'protesto_consulta_cpf_cnpj'},
          {label:'Realizar Apontamento', payload:'protesto_realizar_apontamento'},
          {label:'Certid√£o de Intima√ß√£o', payload:'protesto_certidao_de_intimacao'},
          {label:'Boleto em Apontamento', payload:'protesto_boleto_em_apontamento'},
          {label:'Cancelamento de Protesto', payload:'protesto_cancelamento'},
          {label:'Carta de Anu√™ncia', payload:'protesto_carta_de_anuencia'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  // --- DOM Manipulation Helpers ---
  function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }

  // Add a message bubble to the chat
  function addBubble(text, who='them', html=false){
    const b = el('div','bubble '+who);
    b[html?'innerHTML':'textContent']=text; // Use innerHTML if content is pre-formatted HTML
    const t = el('span','time', now()); b.appendChild(t); // Add timestamp
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight; // Auto-scroll to bottom
    return b; // Return bubble element for potential further manipulation
  }

  // Add a row of buttons for user interaction
  function addButtons(buttons){
    const wrap = el('div','buttons');
    buttons.forEach(btn=>{
        const b=el('button','',btn.label);
        b.addEventListener('click',()=>{
            addBubble(btn.label, 'me'); // Display user's choice in chat
            // Reset states that are not needed for sequential flows before handling payload
            if (btn.payload !== 'setor_' && !btn.payload.startsWith('menu_') && btn.payload !== 'inicio') {
                state.awaitingSector = false;
                state.awaitingDescription = false;
                state.chosenSector = null;
            }
            handlePayload(btn.payload, btn.meta); // Handle the button's action
        });
        wrap.appendChild(b);
    });
    // Wrap buttons in a 'them' bubble for consistent styling
    const bubble = el('div','bubble them');
    bubble.appendChild(wrap);
    chat.appendChild(bubble);
    chat.scrollTop = chat.scrollHeight; // Auto-scroll
  }

  // Get current time formatted as HH:MM
  function now(){ return new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }

  // --- Initialization ---
  function greet(){
      // Display the initial welcome message and menu upon loading
      showInitialMenu();
  }

  // --- Event Listeners ---
  // Send message when button is clicked
  sendBtn.addEventListener('click',()=>{
      const val = input.value.trim();
      if(!val) return; // Do nothing if input is empty
      addBubble(val,'me'); // Display user message
      input.value=''; // Clear input field
      setTimeout(()=>parseFreeText(val), 120); // Process message after a short delay
  });
  // Send message when Enter key is pressed
  input.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ sendBtn.click(); }
  });
  // Handle file uploads (currently just acknowledges receipt)
  fileInp.addEventListener('change',e=>{
      if(!e.target.files.length) return; // Do nothing if no file selected
      addBubble(`${e.target.files.length} arquivo(s) recebido(s). Descreva sua solicita√ß√£o para an√°lise dos anexos.`,'them');
      e.target.value = null; // Clear the file input after processing
  });

  // Start the chat interface when the page loads
  setTimeout(greet, 250); // Use setTimeout to ensure DOM is ready

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cart√≥rio ‚Ä¢ Chat com IA</title>
<style>
  :root{
    --panel:#111b21;
    --accent:#25d366;
    --me:#005c4b;
    --them:#202c33;
    --text:#e9edef;
    --sub:#8696a0;
    --btn:#233138;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:linear-gradient(180deg,#111b21 0%,#0b141a 100%);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;
    color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center;
  }
  .phone{width:min(420px,100vw);height:min(780px,100vh);background:var(--panel);border:1px solid #1f2c33;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.03) inset;display:flex;flex-direction:column;overflow:hidden}
  .topbar{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #1f2c33;background:#1f2c33}
  .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#1d9161,#0f4c3a);display:grid;place-items:center;font-weight:700;color:#d7f6e6}
  .title{display:flex;flex-direction:column;line-height:1.1}
  .title b{font-size:14.5px}
  .title span{font-size:12px;color:var(--sub)}
  .verified{display:inline-block;transform:translateY(1px);margin-left:6px;width:16px;height:16px;border-radius:50%;background:var(--accent);color:#093023;font-size:12px;font-weight:900;display:grid;place-items:center}
  .chat{flex:1;overflow-y:auto;padding:14px;background:url('data:image/svg+xml;utf8,\
    <svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22160%22 height=%22160%22 viewBox=%220 0 160 160%22>\
    <g fill=%22%23202c33%22 fill-opacity=%220.35%22>\
    <circle cx=%2220%22 cy=%2220%22 r=%221%22 />\
    <circle cx=%2290%22 cy=%2280%22 r=%221%22 />\
    <circle cx=%22140%22 cy=%2240%22 r=%221%22 />\
    <circle cx=%2270%22 cy=%22130%22 r=%221%22 />\
    </g></svg>') repeat;background-attachment:fixed}
  .bubble{max-width:85%;padding:10px 12px;border-radius:10px;margin:8px 0;position:relative;box-shadow:0 1px 0 rgba(0,0,0,.1);word-wrap:break-word;white-space:pre-wrap}
  .me{background:var(--me);margin-left:auto;border-top-right-radius:2px}
  .them{background:var(--them);margin-right:auto;border-top-left-radius:2px}
  .time{display:block;text-align:right;color:#b8c6cc;font-size:11px;opacity:.8;margin-top:6px}
  .buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .buttons button{background:var(--btn);color:var(--text);border:1px solid #2c3c43;border-radius:18px;padding:8px 12px;cursor:pointer;font-size:13px}
  .composer{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid #1f2c33;background:#111b21}
  .composer input[type=text]{flex:1;background:#202c33;border:1px solid #2f3b41;color:var(--text);border-radius:20px;padding:12px 14px;font-size:14px;outline:none}
  .composer button{background:var(--accent);color:#06351f;border:0;border-radius:20px;padding:10px 16px;font-weight:700;cursor:pointer}
  .composer label{background:#202c33;border:1px solid #2f3b41;padding:10px;border-radius:20px;cursor:pointer;font-size:13px}
  .link-like{color:#bfe3d2;text-decoration:underline;cursor:pointer}
  .foot{text-align:center;font-size:11px;color:var(--sub);padding:6px 10px;border-top:1px dashed #23313a}
  .toggle{margin-left:auto;font-size:12px;display:flex;gap:8px;align-items:center}
  .toggle input{transform:scale(1.1)}
</style>
</head>
<body>
  <div class="phone" role="application" aria-label="Chat do Cart√≥rio">
    <div class="topbar">
      <div class="avatar" aria-hidden="true">C</div>
      <div class="title">
        <b>Cart√≥rio Oficial</b>
        <span>N√∫mero verificado <span class="verified" title="Verificado">‚úì</span></span>
      </div>
      <div class="toggle" title="Responder usando IA offline">
        <label for="ai">IA</label>
        <input id="ai" type="checkbox" checked>
      </div>
    </div>
    <div id="chat" class="chat" aria-live="polite"></div>
    <div class="composer">
      <input id="text" type="text" placeholder="Digite aqui" autocomplete="off" aria-label="Mensagem">
      <label>üìé<input id="file" type="file" style="display:none" multiple></label>
      <button id="send">Enviar</button>
    </div>
    <div class="foot">Funciona offline no navegador. Pre√ßos e prazos fict√≠cios.</div>
  </div>

<script>
(function(){
  const chat = document.getElementById('chat');
  const input = document.getElementById('text');
  const sendBtn = document.getElementById('send');
  const fileInp = document.getElementById('file');
  const aiToggle = document.getElementById('ai');

  // --- HELPERS ---
  function slugify(text) {
    return text.toString().toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '_')
      .replace(/[^\w-]+/g, '')
      .replace(/_{2,}/g, '_')
      .replace(/^-+/, '')
      .replace(/-+$/, '');
  }

  function parsePrice(value) {
    if (!value) return 'N√£o especificado';
    const cleaned = value.trim();
    const low = cleaned.toLowerCase();
    if (low === 'gratuito') return 'Gratuito';
    if (cleaned === '-' || low.includes('valor a ser calculado') || low === 'r$ -') return 'Valor a ser calculado';
    return cleaned.replace(/\s+/g,' ');
  }

  function parseBoolean(value) {
    if (!value) return false;
    return value.trim().toLowerCase() === 'sim';
  }

  function parseDocuments(value) {
    if (!value || value.trim() === '') return ['Nenhum documento especificado'];
    const cleaned = value.trim();
    if (cleaned.toLowerCase() === 'anexo') return ['Anexo, detalhes ser√£o solicitados'];
    const parts = cleaned.split(/[,;\n]+/).map(doc => doc.trim()).filter(doc => doc);
    return parts.length > 0 ? parts : ['Nenhum documento especificado'];
  }

  function cleanText(value) {
    if (!value) return 'N√£o especificado';
    return value.trim().replace(/\s+/g,' ');
  }

  // --- CSV atualizado ---
  const csvData = `Tabelionato de Notas	Procura√ß√£o P√∫blica	 R$ 120,00 	Sim	WhatsApp	1 dia √∫til 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	1 dia √∫til
Tabelionato de Notas	Escritura P√∫blica	 Valor a ser calculado 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Traslados	 R$ 51,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Carta de Senten√ßa	 Valor a ser calculado 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	Guia de ITBI	 R$ 45,90 	Sim	WhatsApp	1 dia √∫til 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	1 dia √∫til
Tabelionato de Notas	Testamento	 Valor a ser calculado 	Sim	WhatsApp	Prazo indefinido	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Prazo indefinido
Tabelionato de Notas	Ata Notarial	 Valor a ser calculado 	Sim	WhatsApp	Prazo indefinido	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Prazo indefinido
Tabelionato de Notas	Apostilamento de Haia	 R$ 120,00 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Tabelionato de Notas	E - Notariado	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Nascimento	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Casamento	 R$ 501,90 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	√ìbito	 Gratuito 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Registro Civil	Busca de Registro	 R$ 31,45 	Sim	WhatsApp	At√© 30 dias 	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	At√© 30 dias
Registro Civil	2¬™ Via de Certid√£o (Breve Relato)	 R$ 25,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	2¬™ Via de Certid√£o (Inteiro Teor)	 R$ 19,05 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	Livro E 	 R$ 115,95 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Registro Civil	Averba√ß√µes / Retifica√ß√µes	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Reconhecimento de Firma	Abertura de Firma	 R$ 11,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Reconhecimento por Semelhan√ßa	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Reconhecimento por Autenticidade	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autentica√ß√£o	 R$ 4,25 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Materializa√ß√£o 	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autentica√ß√£o Digital	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Desmaterializa√ß√£o 	 R$ 35,70 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Sinal P√∫blico 	 R$ 9,10 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Comunicado de Venda	 R$ 92,09 	Sim	WhatsApp	Imediato	09:00 as 17:00	N√£o	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Reconhecimento de Firma	Autoriza√ß√£o de Viagem Eletr√¥nica	 R$ 199,90 	Sim	WhatsApp	Imediato	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	Imediato
Protesto	Certid√£o Negativa / Positiva	 R$ 51,50 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Consulta CPF / CNPJ	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Realizar Apontamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Certid√£o de Intima√ß√£o 	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Boleto em Apontamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Cancelamento	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis
Protesto	Carta de Anu√™ncia 	 R$ 199,90 	Sim	WhatsApp	5 dias √∫teis	09:00 as 17:00	Sim	Anexo	N√£o	Online Engenharia de Sistemas	D√©bito ou Pix	5 dias √∫teis`;

  const serviceLines = csvData.trim().split('\n');
  const headers = ['setor','servico','valor_bruto','responsavel_interno','canal_abertura','tempo_medio_resposta','horario_atendimento','pode_ser_online_100','documentos_necessarios','encaminhar_orgao','sistema_usado','forma_pagamento','prazo_entrega'];

  const services = serviceLines.map(line => {
      const values = line.split('\t');
      const serviceData = {};
      headers.forEach((header, index) => { serviceData[header] = values[index] ? values[index].trim() : ''; });

      const setor = cleanText(serviceData.setor);
      const servico = cleanText(serviceData.servico);
      const id = slugify(servico);

      return {
          id,
          setor,
          nome: servico,
          valor_formatado: parsePrice(serviceData.valor_bruto),
          responsavel_interno: parseBoolean(serviceData.responsavel_interno),
          canal_abertura: cleanText(serviceData.canal_abertura),
          tempo_medio_resposta: cleanText(serviceData.tempo_medio_resposta),
          horario_atendimento: cleanText(serviceData.horario_atendimento),
          pode_ser_online_100: parseBoolean(serviceData.pode_ser_online_100),
          documentos: parseDocuments(serviceData.documentos_necessarios),
          encaminhar_orgao: parseBoolean(serviceData.encaminhar_orgao),
          sistema_usado: cleanText(serviceData.sistema_usado),
          forma_pagamento: cleanText(serviceData.forma_pagamento),
          prazo_entrega: cleanText(serviceData.prazo_entrega)
      };
  });

  const setores = ['Tabelionato de Notas','Registro Civil','Reconhecimento de Firma','Protesto','Financeiro','Atendimento Geral','Ouvidoria'];

  const bank = {
    banco:'Banco Modelo S.A.',
    agencia:'0001',
    conta:'12345-6',
    tipo:'Conta Corrente',
    titular:'Cart√≥rio Modelo de Notas e Registro',
    cnpj:'12.345.678/0001-99',
    pix:'12345678000199',
    aviso:'Use somente estes dados. O cart√≥rio n√£o envia mensagens por n√∫meros diferentes nem solicita pagamento por links aleat√≥rios.'
  };

  // --- IA atualizada ---
  const IA = (function(){
    const intents = {
      dados_bancarios:{'pix':2,'dados':1.5,'banc':1.5,'conta':1.3,'ag√™ncia':1.2,'agencia':1.2,'transfer':1.2,'pagamento':1.0},
      status:{'status':2,'protocolo':2,'andamento':1.5,'acompanhar':1.5,'atd':1.8},
      atendente:{'humano':2,'pessoa':1.5,'atendente':2,'falar':1.2,'setor':1.0},
      tabela_precos:{'pre√ßo':2,'precos':2,'valor':2,'tabela':2,'quanto':1.3,'custa':1.3},

      procuracao_publica:{'procura√ß√£o':2,'procuracao':2},
      escritura_publica:{'escritura':2},
      traslados:{'traslado':2,'traslados':2},
      carta_de_sentenca:{'carta':2,'senten√ßa':2,'sentenca':2},
      guia_de_itbi:{'itbi':3,'guia':2},
      testamento:{'testamento':3},
      ata_notarial:{'ata':3,'notarial':3},
      apostilamento_de_haia:{'apostilamento':3,'haia':3},
      e_notariado:{'e-notariado':3,'digital':2},

      nascimento:{'nascimento':3},
      casamento:{'casamento':3},
      obito:{'obito':3,'√≥bito':3},
      busca_de_registro:{'busca':3,'registro':1.5},
      '2a_via_de_certidao_breve_relato':{'breve':2,'relato':2},
      '2a_via_de_certidao_inteiro_teor':{'inteiro':2,'teor':2},
      livro_e:{'livro':2,'e':1},
      averbacoes_retificacoes:{'averba√ß√£o':3,'retifica√ß√£o':3,'averbacao':3,'retificacao':3},

      abertura_de_firma:{'abertura':2,'firma':3},
      reconhecimento_por_semelhanca:{'semelhan√ßa':3,'semelhanca':3},
      reconhecimento_por_autenticidade:{'autenticidade':3},
      autenticacao:{'autentica√ß√£o':3,'autenticacao':3,'c√≥pia':2,'copia':2},
      materializacao:{'materializa√ß√£o':3,'materializacao':3},
      autenticacao_digital:{'autentica√ß√£o':3,'autenticacao':3,'digital':2},
      desmaterializacao:{'desmaterializa√ß√£o':3,'desmaterializacao':3},
      sinal_publico:{'sinal':2,'p√∫blico':2,'publico':2},
      comunicado_de_venda:{'comunicado':2,'venda':3},
      autorizacao_de_viagem_eletronica:{'autoriza√ß√£o':3,'autorizacao':3,'viagem':2,'eletr√¥nica':1.5},

      certidao_negativa_positiva:{'certid√£o':2,'negativa':1.5,'positiva':1.5},
      consulta_cpf_cnpj:{'consulta':2,'cpf':1.5,'cnpj':1.5},
      realizar_apontamento:{'apontamento':3,'realizar':2},
      certidao_de_intimacao:{'certid√£o':2,'intima√ß√£o':2,'intimacao':2},
      boleto_em_apontamento:{'boleto':2,'apontamento':2},
      cancelamento:{'cancelamento':3},
      carta_de_anuencia:{'anu√™ncia':3,'anuencia':3}
    };

    function tokenize(text){
      return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/[^a-z0-9]+/).filter(Boolean);
    }

    function score(text){
      const toks = tokenize(text);
      const scores = {};
      for(const intent in intents){
        let s = 0;
        const w = intents[intent];
        for(const tk of toks){
          for(const key in w){
            const k = key.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
            if(tk.startsWith(k)) s += w[key];
          }
        }
        if(text.toLowerCase().includes('dados banc')) s += 0.5;
        scores[intent]=s;
      }
      let best = {intent:'',score:0};
      for(const k in scores){ if(scores[k]>best.score){ best={intent:k,score:scores[k]}; } }
      return best;
    }
    return {score};
  })();

  const iaIntentToPayloadMap = {
    dados_bancarios:'dados_bancarios',
    status:'status',
    atendente:'atendente',
    tabela_precos:'tabela_precos',

    procuracao_publica:'procuracao_publica',
    escritura_publica:'escritura_publica',
    traslados:'traslados',
    carta_de_sentenca:'carta_de_sentenca',
    guia_de_itbi:'guia_de_itbi',
    testamento:'testamento',
    ata_notarial:'ata_notarial',
    apostilamento_de_haia:'apostilamento_de_haia',
    e_notariado:'e_notariado',

    nascimento:'nascimento',
    casamento:'casamento',
    obito:'obito',
    busca_de_registro:'busca_de_registro',
    '2a_via_de_certidao_breve_relato':'2a_via_de_certidao_breve_relato',
    '2a_via_de_certidao_inteiro_teor':'2a_via_de_certidao_inteiro_teor',
    livro_e:'livro_e',
    averbacoes_retificacoes:'averbacoes_retificacoes',

    abertura_de_firma:'abertura_de_firma',
    reconhecimento_por_semelhanca:'reconhecimento_por_semelhanca',
    reconhecimento_por_autenticidade:'reconhecimento_por_autenticidade',
    autenticacao:'autenticacao',
    materializacao:'materializacao',
    autenticacao_digital:'autenticacao_digital',
    desmaterializacao:'desmaterializacao',
    sinal_publico:'sinal_publico',
    comunicado_de_venda:'comunicado_de_venda',
    autorizacao_de_viagem_eletronica:'autorizacao_de_viagem_eletronica',

    certidao_negativa_positiva:'certidao_negativa_positiva',
    consulta_cpf_cnpj:'consulta_cpf_cnpj',
    realizar_apontamento:'realizar_apontamento',
    certidao_de_intimacao:'certidao_de_intimacao',
    boleto_em_apontamento:'boleto_em_apontamento',
    cancelamento:'cancelamento',
    carta_de_anuencia:'carta_de_anuencia'
  };

  // busca servi√ßo por ID
  function findServiceById(id) {
    return services.find(s => s.id === id);
  }

  function formatServiceDetails(service) {
      if (!service) return 'Servi√ßo n√£o encontrado';
      let details = `Servi√ßo ${service.nome}\n`;
      details += `Setor ${service.setor}\n`;
      details += `Valor ${service.valor_formatado}\n`;
      details += `Prazo de entrega ${service.prazo_entrega}\n`;
      details += `Tempo m√©dio de resposta inicial ${service.tempo_medio_resposta}\n`;
      details += `Hor√°rio de atendimento ${service.horario_atendimento}\n`;
      details += `Pode ser feito 100% online? ${service.pode_ser_online_100 ? 'Sim' : 'N√£o'}\n`;
      details += `Forma de pagamento ${service.forma_pagamento}\n`;
      details += `Respons√°vel Interno ${service.responsavel_interno ? 'Sim' : 'N√£o'}\n`;
      details += `Encaminhar para outro √≥rg√£o? ${service.encaminhar_orgao ? 'Sim' : 'N√£o'}\n`;
      if (service.sistema_usado && service.sistema_usado !== 'N√£o especificado') {
          details += `Sistema utilizado ${service.sistema_usado}\n`;
      }
      details += `\nDocumentos Necess√°rios\n`;
      if (service.documentos.length > 0) {
          service.documentos.forEach(doc => { details += `‚Ä¢ ${doc}\n`; });
      } else {
          details += '‚Ä¢ Nenhum documento especificado';
      }
      return details;
  }

  function checklistBlob(service){
      const text=[
          `--- Checklist ${service.nome} ---`,
          `Setor ${service.setor}`,
          `Valor Estimado ${service.valor_formatado}`,
          `Prazo Estimado ${service.prazo_entrega}`,
          `Hor√°rio de Atendimento ${service.horario_atendimento}`,
          `Pode ser feito 100% online? ${service.pode_ser_online_100 ? 'Sim' : 'N√£o'}`,
          `Forma de Pagamento ${service.forma_pagamento}`,
          '',
          'Documentos Necess√°rios',
          ...(service.documentos.length > 0 ? service.documentos.map((d,i)=>`${i+1}. ${d}`) : ['Nenhum especificado']),
          '',
          'Observa√ß√µes',
          'Checklist demonstrativo'
      ].join('\n');
      return URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  }

  function showService(serviceId){
    const service = findServiceById(serviceId);
    if(!service) { addBubble('N√£o encontrei informa√ß√µes para este servi√ßo. Tente novamente ou pe√ßa atendente','them'); return; }
    const formattedDetails = formatServiceDetails(service);
    const bubble = addBubble(formattedDetails,'them');
    const link = el('span','link-like','Baixar checklist');
    link.addEventListener('click',()=>{
        const url=checklistBlob(service);
        const a=document.createElement('a');
        a.href=url;
        a.download=`Checklist - ${slugify(service.nome)}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    });
    bubble.appendChild(el('div','time',' '));
    bubble.appendChild(link);
    addButtons([
      {label:'Falar com atendente',payload:'atendente',meta:{setor:service.setor,assunto:service.nome}},
      {label:'In√≠cio',payload:'inicio'}
    ]);
  }

  function showTabela(){
      const rows = services.map(s =>
          `<tr>
             <td>${s.nome}</td>
             <td>${s.setor}</td>
             <td>${s.valor_formatado}</td>
             <td>${s.prazo_entrega}</td>
             <td>${s.pode_ser_online_100 ? 'Sim' : 'N√£o'}</td>
           </tr>`
      ).join('');
      addBubble('Tabela demonstrativa de servi√ßos','them');
      addBubble(`
          <table style="width:100%;border-collapse:collapse;font-size:13px">
              <thead>
                  <tr>
                      <th style="border:1px solid #2a3a41;padding:6px">Servi√ßo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Setor</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Pre√ßo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Prazo</th>
                      <th style="border:1px solid #2a3a41;padding:6px">Online?</th>
                  </tr>
              </thead>
              <tbody>${rows}</tbody>
          </table>`,'them',true);
      addButtons([{label:'In√≠cio',payload:'inicio'}]);
  }

  function showBank(){
      addBubble(`Dados oficiais para pagamento\nBanco ${bank.banco}\nAg√™ncia ${bank.agencia}\nConta ${bank.conta}\nTipo ${bank.tipo}\nTitular ${bank.titular}\nCNPJ ${bank.cnpj}\nPix ${bank.pix}`,'them');
      addBubble(bank.aviso,'them');
      addButtons([{label:'Copiar Pix',payload:'copiar_pix'},{label:'In√≠cio',payload:'inicio'}]);
  }

  function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(()=>addBubble('Chave PIX copiada. Cole no seu aplicativo banc√°rio','them')).catch(()=>addBubble('Falha ao copiar. Copie manualmente','them'));
  }

  // --- HANDOFF E STATUS ---
  const state = { awaitingSector:false, awaitingDescription:false, awaitingStatusId:false, chosenSector:null };

  function startHandoff(pref){
      state.awaitingSector=true; state.chosenSector=null;
      const intro = pref && pref.assunto ? `Encaminho para o setor de ${pref.setor} com assunto "${pref.assunto}" confirme o setor ou escolha outro` : `Para atendimento humano escolha o setor desejado ou descreva sua demanda`;
      addBubble(intro,'them');
      addButtons(setores.map(s => ({label:s, payload:'setor_'+s})).concat([{label:'Cancelar',payload:'inicio'}]));
  }

  function confirmSector(sector){
      state.awaitingSector=false; state.awaitingDescription=true; state.chosenSector=sector;
      addBubble(`Setor "${sector}" selecionado descreva sua demanda em uma frase`,'them');
  }

  function openTicket(desc){
      const id='ATD-'+Date.now().toString().slice(-6);
      const sectorForStore = state.chosenSector;
      addBubble(`Atendimento iniciado com sucesso\nProtocolo ${id}\nSetor ${sectorForStore}\nResumo ${desc}\nUm atendente vai responder`,'them');
      state.awaitingDescription=false; state.chosenSector=null;
      localStorage.setItem(id, JSON.stringify({id, status:'Em an√°lise', sector:sectorForStore, description:desc, requestedAt: new Date().toISOString()}));
      addButtons([{label:'Verificar Status', payload:'status', meta:{id:id}}, {label:'In√≠cio', payload:'inicio'}]);
  }

  function checkStatusFlow(){
      state.awaitingStatusId=true;
      addBubble('Informe o protocolo iniciado com ATD por exemplo ATD-123456 para verificar o status','them');
  }

  function resolveStatus(id){
      const raw=localStorage.getItem(id);
      if(!raw){ addBubble('Protocolo n√£o localizado verifique o n√∫mero e tente novamente','them'); state.awaitingStatusId=false; return;}
      const data=JSON.parse(raw);

      const requestedTime = new Date(data.requestedAt);
      const now = new Date();
      const diffMinutes = (now - requestedTime) / (1000 * 60);

      let status = 'Em an√°lise';
      if (diffMinutes < 15) status = 'Em an√°lise';
      else if (diffMinutes < 60) status = 'Aguardando triagem';
      else if (diffMinutes < 180) status = 'Em andamento';
      else status = 'Aguardando resposta final';

      addBubble(`Protocolo ${id}\nSetor ${data.sector}\nStatus ${status}\nDescri√ß√£o ${data.description}`,'them');
      state.awaitingStatusId=false;
      addButtons([{label:'In√≠cio',payload:'inicio'}]);
  }

  // --- CORE ---
  function handlePayload(payload, meta){
    if (payload.startsWith('menu_')) {
        switch (payload) {
            case 'menu_certidoes': showCertidoesMenu(); break;
            case 'menu_reconhecimento': showReconhecimentoMenu(); break;
            case 'menu_autenticacao': showAutenticacaoMenu(); break;
            case 'menu_procuracoes_escrituras': showProcuracoesEscriturasMenu(); break;
            case 'menu_protesto': showProtestoMenu(); break;
            default: addBubble(`Menu desconhecido ${payload}`, 'them');
        }
        return;
    }

    switch (payload) {
        case 'inicio':
            addBubble('Como posso ajudar hoje','them');
            showMainMenu();
            return;
        case 'copiar_pix':
            copyToClipboard(bank.pix);
            return;
        case 'atendente':
            startHandoff(meta);
            return;
        case 'status':
            if (meta && meta.id) { resolveStatus(meta.id); return; }
            checkStatusFlow();
            return;
        case 'dados_bancarios':
            showBank();
            return;
        case 'tabela_precos':
            showTabela();
            return;
    }

    if (payload.startsWith('setor_')) {
        confirmSector(payload.replace('setor_', ''));
        return;
    }

    const service = findServiceById(payload);
    if (service) { showService(service.id); return; }

    addBubble(`N√£o entendi o comando ou servi√ßo "${payload}" use os bot√µes ou digite o nome de um servi√ßo`,'them');
  }

  function iaRoute(text){
    const result = IA.score(text);
    if(result.score < 1.8) return null;
    const mappedPayload = iaIntentToPayloadMap[result.intent];
    return mappedPayload || null;
  }

  function parseFreeText(text){
    const t = text.toLowerCase();

    if(state.awaitingSector && t){
        const sector = setores.find(s => s.toLowerCase() === t);
        if(sector){ confirmSector(sector); return; }
    }
    if(state.awaitingDescription && t){ openTicket(text); return; }
    if(state.awaitingStatusId){
        const id = text.trim().toUpperCase();
        if(/^ATD-\d{6}$/.test(id)){ resolveStatus(id); return; }
        addBubble('Formato de protocolo inv√°lido use ATD-123456','them');
        return;
    }

    if (t.includes('certid√µes') || t.includes('registro') || t.includes('nascimento') || t.includes('casamento') || t.includes('√≥bito')) { handlePayload('menu_certidoes'); return; }
    if (t.includes('reconhecimento') || t.includes('firma') || t.includes('autentica√ß√£o') || t.includes('c√≥pia') || t.includes('xerox') || t.includes('materializa√ß√£o') || t.includes('desmaterializa√ß√£o') || t.includes('sinal p√∫blico') || t.includes('comunicado de venda') || t.includes('autoriza√ß√£o de viagem')) { handlePayload('menu_reconhecimento'); return; }
    if (t.includes('procura√ß√£o') || t.includes('escritura') || t.includes('im√≥vel') || t.includes('venda') || t.includes('compra') || t.includes('traslado') || t.includes('itbi') || t.includes('testamento') || t.includes('ata notarial') || t.includes('haia') || t.includes('e-notariado')) { handlePayload('menu_procuracoes_escrituras'); return; }
    if (t.includes('protesto') || t.includes('apontamento') || t.includes('anu√™ncia') || t.includes('boleto')) { handlePayload('menu_protesto'); return; }

    const directServiceMatch = services.find(s =>
        s.id.toLowerCase() === t ||
        s.nome.toLowerCase().includes(t) ||
        s.nome.toLowerCase().split(' ').some(word => t.includes(word))
    );
    if (directServiceMatch) { handlePayload(directServiceMatch.id); return; }

    if(aiToggle.checked){
      const iaPayload = iaRoute(text);
      if(iaPayload){ handlePayload(iaPayload); return; }
    }

    if(t.includes('atendente') || t.includes('humano') || t.includes('falar com')) { handlePayload('atendente'); return; }
    if(t.includes('dados banc') || t.includes('pix') || t.includes('conta')) { handlePayload('dados_bancarios'); return; }
    if(t.includes('tabela') || t.includes('pre√ßo') || t.includes('valor') || t.includes('quanto custa')) { handlePayload('tabela_precos'); return; }

    addBubble('N√£o entendi use os bot√µes ou digite o nome do servi√ßo por exemplo Nascimento ou Procura√ß√£o ou digite atendente para falar com um humano','them');
  }

  // --- UI ---
  function showMainMenu(){
      addButtons([
          {label:'Certid√µes e Registros', payload:'menu_certidoes'},
          {label:'Reconhecimento de Firma', payload:'menu_reconhecimento'},
          {label:'Autentica√ß√£o de C√≥pia', payload:'menu_autenticacao'},
          {label:'Procura√ß√µes e Escrituras', payload:'menu_procuracoes_escrituras'},
          {label:'Protesto', payload:'menu_protesto'},
          {label:'Tabela de Pre√ßos Completa', payload:'tabela_precos'},
          {label:'Dados Banc√°rios/PIX', payload:'dados_bancarios'},
          {label:'Falar com Atendente', payload:'atendente'}
      ]);
  }

  function showCertidoesMenu(){
      addButtons([
          {label:'Nascimento', payload:'nascimento'},
          {label:'Casamento', payload:'casamento'},
          {label:'√ìbito', payload:'obito'},
          {label:'Busca de Registro', payload:'busca_de_registro'},
          {label:'2¬™ Via Breve Relato', payload:'2a_via_de_certidao_breve_relato'},
          {label:'2¬™ Via Inteiro Teor', payload:'2a_via_de_certidao_inteiro_teor'},
          {label:'Livro E', payload:'livro_e'},
          {label:'Averba√ß√µes e Retifica√ß√µes', payload:'averbacoes_retificacoes'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  function showReconhecimentoMenu(){
      addButtons([
          {label:'Abertura de Firma', payload:'abertura_de_firma'},
          {label:'Reconhecimento por Semelhan√ßa', payload:'reconhecimento_por_semelhanca'},
          {label:'Reconhecimento por Autenticidade', payload:'reconhecimento_por_autenticidade'},
          {label:'Autentica√ß√£o de C√≥pia', payload:'autenticacao'},
          {label:'Materializa√ß√£o', payload:'materializacao'},
          {label:'Autentica√ß√£o Digital', payload:'autenticacao_digital'},
          {label:'Desmaterializa√ß√£o', payload:'desmaterializacao'},
          {label:'Sinal P√∫blico', payload:'sinal_publico'},
          {label:'Comunicado de Venda', payload:'comunicado_de_venda'},
          {label:'Autoriza√ß√£o de Viagem Eletr√¥nica', payload:'autorizacao_de_viagem_eletronica'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  function showAutenticacaoMenu() {
      addBubble('Para autentica√ß√£o de c√≥pias escolha uma op√ß√£o','them');
      showReconhecimentoMenu();
  }

  function showProcuracoesEscriturasMenu(){
      addButtons([
          {label:'Procura√ß√£o P√∫blica', payload:'procuracao_publica'},
          {label:'Escritura P√∫blica', payload:'escritura_publica'},
          {label:'Traslados', payload:'traslados'},
          {label:'Carta de Senten√ßa', payload:'carta_de_sentenca'},
          {label:'Guia de ITBI', payload:'guia_de_itbi'},
          {label:'Testamento', payload:'testamento'},
          {label:'Ata Notarial', payload:'ata_notarial'},
          {label:'Apostilamento de Haia', payload:'apostilamento_de_haia'},
          {label:'E-Notariado', payload:'e_notariado'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  function showProtestoMenu(){
      addButtons([
          {label:'Certid√£o Negativa ou Positiva', payload:'certidao_negativa_positiva'},
          {label:'Consulta CPF ou CNPJ', payload:'consulta_cpf_cnpj'},
          {label:'Realizar Apontamento', payload:'realizar_apontamento'},
          {label:'Certid√£o de Intima√ß√£o', payload:'certidao_de_intimacao'},
          {label:'Boleto em Apontamento', payload:'boleto_em_apontamento'},
          {label:'Cancelamento de Protesto', payload:'cancelamento'},
          {label:'Carta de Anu√™ncia', payload:'carta_de_anuencia'},
          {label:'Voltar', payload:'inicio'}
      ]);
  }

  // --- DOM ---
  function el(tag, cls, html){ const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e; }
  function addBubble(text, who='them', html=false){
    const b = el('div','bubble '+who);
    b[html?'innerHTML':'textContent']=text;
    const t = el('span','time', now()); b.appendChild(t);
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
    return b;
  }
  function addButtons(buttons){
    const wrap = el('div','buttons');
    buttons.forEach(btn=>{
        const b=el('button','',btn.label);
        b.addEventListener('click',()=>{
            addBubble(btn.label, 'me');
            handlePayload(btn.payload, btn.meta);
        });
        wrap.appendChild(b);
    });
    const bubble = el('div','bubble them');
    bubble.appendChild(wrap);
    chat.appendChild(bubble);
    chat.scrollTop = chat.scrollHeight;
  }
  function now(){ return new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }

  // --- INIT ---
  function greet(){
      addBubble('Ol√° bem-vindo ao assistente virtual do Cart√≥rio','them');
      addBubble('Posso informar servi√ßos valores prazos documentos e status voc√™ pode digitar o nome do servi√ßo direto','them');
      showMainMenu();
  }
  setTimeout(greet, 250);

  sendBtn.addEventListener('click',()=>{
      const val = input.value.trim();
      if(!val) return;
      addBubble(val,'me');
      input.value='';
      setTimeout(()=>parseFreeText(val), 120);
  });
  input.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ sendBtn.click(); }
  });
  fileInp.addEventListener('change',e=>{
      if(!e.target.files.length) return;
      addBubble(`${e.target.files.length} arquivo(s) recebidos descreva sua solicita√ß√£o para an√°lise dos anexos`,'them');
      e.target.value = null;
  });
})();
</script>
</body>
</html>
